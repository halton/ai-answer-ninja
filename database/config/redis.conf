# AI Answer Ninja - Redis Configuration
# Optimized for high-performance caching and real-time operations

# ===========================================
# Network Configuration
# ===========================================

# Bind to all interfaces in Docker, specific interface in production
bind 0.0.0.0
port 6379

# TCP listen() backlog
tcp-backlog 511

# TCP keepalive
tcp-keepalive 300

# ===========================================
# Security Configuration
# ===========================================

# Require authentication (set via environment variable)
# requirepass ${REDIS_PASSWORD}

# Disable dangerous commands in production
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command KEYS ""
rename-command CONFIG "ADMIN_CONFIG_b840fc02d524045429941cc15f59e41cb7be6c52"
rename-command DEBUG "ADMIN_DEBUG_b840fc02d524045429941cc15f59e41cb7be6c52"
rename-command EVAL "ADMIN_EVAL_b840fc02d524045429941cc15f59e41cb7be6c52"
rename-command SHUTDOWN "ADMIN_SHUTDOWN_b840fc02d524045429941cc15f59e41cb7be6c52"

# Protected mode (disable for Docker networking)
protected-mode no

# ===========================================
# General Configuration
# ===========================================

# Database count
databases 16

# Always show a logo
always-show-logo yes

# Set server verbosity to 'notice'
loglevel notice

# Log file (empty string = stdout)
logfile ""

# Syslog enabled
syslog-enabled yes
syslog-ident redis-ai-ninja

# ===========================================
# Memory Management
# ===========================================

# Maximum memory usage (set via environment variable)
# maxmemory 2gb

# Memory policy when max memory is reached
maxmemory-policy allkeys-lru

# Memory sampling for LRU/LFU algorithms
maxmemory-samples 5

# ===========================================
# Persistence Configuration
# ===========================================

# RDB Snapshots
# Save the DB on disk:
# save <seconds> <changes>
save 900 1     # Save if at least 1 key changed in 900 seconds
save 300 10    # Save if at least 10 keys changed in 300 seconds
save 60 10000  # Save if at least 10000 keys changed in 60 seconds

# Compress RDB files
rdbcompression yes

# Checksum RDB files
rdbchecksum yes

# RDB filename
dbfilename ai-ninja-dump.rdb

# Working directory
dir /data

# AOF (Append Only File) persistence
appendonly yes
appendfilename "ai-ninja-appendonly.aof"

# AOF sync policy
appendfsync everysec

# Disable fsync when rewriting AOF
no-appendfsync-on-rewrite no

# AOF rewrite configuration
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# AOF load truncated files
aof-load-truncated yes

# AOF use RDB preamble
aof-use-rdb-preamble yes

# ===========================================
# Replication Configuration
# ===========================================

# Master authentication
# masterauth ${REDIS_MASTER_PASSWORD}

# Replica priority for sentinel
replica-priority 100

# Minimum replicas for writes
# min-replicas-to-write 1
# min-replicas-max-lag 10

# ===========================================
# Performance Optimization
# ===========================================

# Lazy freeing
lazyfree-lazy-eviction yes
lazyfree-lazy-expire yes
lazyfree-lazy-server-del yes
replica-lazy-flush yes

# Hash optimization
hash-max-ziplist-entries 512
hash-max-ziplist-value 64

# List optimization
list-max-ziplist-size -2
list-compress-depth 0

# Set optimization
set-max-intset-entries 512

# Sorted set optimization
zset-max-ziplist-entries 128
zset-max-ziplist-value 64

# HyperLogLog optimization
hll-sparse-max-bytes 3000

# Stream optimization
stream-node-max-bytes 4096
stream-node-max-entries 100

# ===========================================
# Slow Log Configuration
# ===========================================

# Slow log configuration
slowlog-log-slower-than 10000  # 10ms
slowlog-max-len 128

# ===========================================
# Client Configuration
# ===========================================

# Max clients
maxclients 10000

# Client timeout (0 = disabled)
timeout 300

# Client output buffer limits
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# Client query buffer limit
client-query-buffer-limit 1gb

# Protocol max bulk length
proto-max-bulk-len 512mb

# ===========================================
# Advanced Configuration
# ===========================================

# Hash function for cluster
# cluster-require-full-coverage yes

# Latency monitoring
latency-monitor-threshold 100

# Notify keyspace events
notify-keyspace-events "Ex"

# Stop writes on background save error
stop-writes-on-bgsave-error yes

# ===========================================
# Modules and Extensions
# ===========================================

# Load Redis modules if available
# loadmodule /usr/lib/redis/modules/redisearch.so
# loadmodule /usr/lib/redis/modules/redisjson.so

# ===========================================
# AI Answer Ninja Specific Settings
# ===========================================

# Database allocation:
# DB 0: User sessions and authentication
# DB 1: Call processing cache (real-time)
# DB 2: User profiles and preferences
# DB 3: Whitelist cache
# DB 4: AI response cache
# DB 5: Performance metrics and monitoring
# DB 6: Rate limiting and security
# DB 7: Background job queues
# DB 8: Analytics and reporting cache
# DB 9: Configuration cache
# DB 10-15: Reserved for future use

# Custom key naming conventions:
# user:session:{user_id} - User session data
# call:processing:{call_id} - Real-time call processing state
# profile:{phone_hash} - User/caller profile cache
# whitelist:{user_id}:{phone_hash} - Whitelist lookup cache
# ai:response:{intent_hash} - AI response cache
# metrics:{metric_name}:{timestamp} - Performance metrics
# ratelimit:{ip}:{endpoint} - Rate limiting counters
# queue:{queue_name} - Background job queues
# analytics:{report_type}:{date} - Analytics cache
# config:{service}:{key} - Configuration cache

# ===========================================
# Monitoring and Debugging
# ===========================================

# Enable debug mode for development
# debug-mode yes

# Track operation latency
latency-tracking yes
latency-tracking-info-percentiles 50 99 99.9

# Memory usage tracking
memory-usage-tracking yes

# ===========================================
# Backup and Recovery
# ===========================================

# Background save configuration
save-empty-db-on-startup no

# RDB file integrity
rdb-save-incremental-fsync yes

# ===========================================
# Production Optimizations
# ===========================================

# Disable THP (Transparent Huge Pages) warnings
# This should be done at OS level: echo never > /sys/kernel/mm/transparent_hugepage/enabled

# TCP nodelay
tcp-nodelay yes

# SO_REUSEPORT for better performance
# Enable if supported by OS
port 0
so-reuseport yes
port 6379

# ===========================================
# Security Headers
# ===========================================

# ACL (Access Control List) configuration
# ACL users are configured via separate ACL file or commands
# aclfile /etc/redis/users.acl

# Default user (disable for security)
user default off

# Application user
user ai_ninja_app on >ai_ninja_secure_password ~* &* +@all -@dangerous

# Readonly user for monitoring
user ai_ninja_readonly on >ai_ninja_readonly_password ~* &* +@read +info +ping +select

# Admin user (for emergency access)
user ai_ninja_admin on >ai_ninja_admin_password ~* &* +@all

# ===========================================
# Environment-specific Overrides
# ===========================================

# Include environment-specific configuration
# Development: Lower memory limits, more verbose logging
# Production: Higher limits, security hardening
# include /etc/redis/redis-${ENVIRONMENT}.conf