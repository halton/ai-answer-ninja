# Upstream server definitions for load balancing
# Each service can have multiple instances for high availability

upstream phone-gateway {
    least_conn;  # Load balancing method
    server phone-gateway:3001 max_fails=3 fail_timeout=30s;
    # Add more instances when scaling:
    # server phone-gateway-2:3001 max_fails=3 fail_timeout=30s backup;
    keepalive 16;
}

upstream realtime-processor {
    least_conn;
    server realtime-processor:3002 max_fails=3 fail_timeout=30s;
    # server realtime-processor-2:3002 max_fails=3 fail_timeout=30s;
    keepalive 32;  # Higher keepalive for real-time processing
}

upstream conversation-engine {
    least_conn;
    server conversation-engine:3003 max_fails=3 fail_timeout=30s;
    # server conversation-engine-2:3003 max_fails=3 fail_timeout=30s;
    keepalive 16;
}

upstream profile-analytics {
    least_conn;
    server profile-analytics:3004 max_fails=3 fail_timeout=30s;
    # server profile-analytics-2:3004 max_fails=3 fail_timeout=30s;
    keepalive 8;
}

upstream user-management {
    ip_hash;  # Session affinity for user sessions
    server user-management:3005 max_fails=3 fail_timeout=30s;
    # server user-management-2:3005 max_fails=3 fail_timeout=30s;
    keepalive 16;
}

upstream smart-whitelist {
    least_conn;
    server smart-whitelist:3006 max_fails=3 fail_timeout=30s;
    # server smart-whitelist-2:3006 max_fails=3 fail_timeout=30s;
    keepalive 16;
}

upstream configuration {
    round_robin;  # Simple round-robin for config requests
    server configuration:3007 max_fails=2 fail_timeout=60s;
    # server configuration-2:3007 max_fails=2 fail_timeout=60s backup;
    keepalive 4;
}

upstream storage {
    least_conn;
    server storage:3008 max_fails=3 fail_timeout=30s;
    # server storage-2:3008 max_fails=3 fail_timeout=30s;
    keepalive 8;
}

upstream monitoring {
    least_conn;
    server monitoring:3009 max_fails=2 fail_timeout=60s;
    # server monitoring-2:3009 max_fails=2 fail_timeout=60s backup;
    keepalive 4;
}