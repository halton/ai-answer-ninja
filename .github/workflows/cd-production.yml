name: Deploy to Production

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy (tag or SHA)'
        required: true
      services:
        description: 'Services to deploy (comma-separated or "all")'
        required: true
        default: 'all'
      deployment_strategy:
        description: 'Deployment strategy'
        required: true
        type: choice
        options:
        - rolling
        - canary
        - blue-green
        default: rolling
      skip_checks:
        description: 'Skip pre-deployment checks (emergency deployment)'
        required: false
        type: boolean
        default: false

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  NODE_VERSION: '20.x'

jobs:
  # ç”Ÿäº§ç¯å¢ƒå‡†å¤‡æ£€æŸ¥
  pre-production-checks:
    name: Pre-production Validation
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip_checks }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.version || github.ref }}

      - name: Validate release tag
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          if [[ ! "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Invalid version tag format: $TAG"
            echo "Expected format: v1.2.3"
            exit 1
          fi

      - name: Check staging deployment status
        run: |
          # éªŒè¯stagingç¯å¢ƒå¥åº·çŠ¶æ€
          STAGING_HEALTH=$(curl -s -o /dev/null -w "%{http_code}" https://staging.ai-answer-ninja.com/health)
          if [ "$STAGING_HEALTH" != "200" ]; then
            echo "Staging environment is unhealthy (HTTP $STAGING_HEALTH)"
            echo "Production deployment requires healthy staging environment"
            exit 1
          fi

      - name: Verify database migrations
        run: |
          # æ£€æŸ¥æ•°æ®åº“è¿ç§»çŠ¶æ€
          echo "Checking database migration compatibility..."
          npm run db:migration:verify:production
        env:
          DATABASE_URL: ${{ secrets.PROD_DATABASE_URL_READ_ONLY }}

      - name: Security compliance check
        run: |
          # æœ€ç»ˆå®‰å…¨åˆè§„æ£€æŸ¥
          echo "Running production security compliance checks..."
          npm run security:compliance:check
        env:
          SECURITY_SCAN_TOKEN: ${{ secrets.SECURITY_SCAN_TOKEN }}

      - name: Load testing verification
        run: |
          # ç¡®ä¿æœ€æ–°çš„è´Ÿè½½æµ‹è¯•é€šè¿‡
          echo "Verifying latest load test results..."
          if ! npm run test:load:verify:latest; then
            echo "Latest load tests failed or not found"
            echo "Production deployment requires passing load tests"
            exit 1
          fi

  # æ„å»ºç”Ÿäº§é•œåƒ
  build-production-images:
    name: Build Production Images
    runs-on: ubuntu-latest
    needs: pre-production-checks
    if: always() && (needs.pre-production-checks.result == 'success' || inputs.skip_checks)
    
    strategy:
      matrix:
        service:
          - phone-gateway
          - configuration-service
          - monitoring
          - smart-whitelist-node
    
    outputs:
      image-digest: ${{ steps.build.outputs.digest }}
      image-tags: ${{ steps.meta.outputs.tags }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.version || github.ref }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ matrix.service }}
          tags: |
            type=ref,event=tag
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=raw,value=production-latest

      - name: Build and push production image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: ./services/${{ matrix.service }}
          file: ./services/${{ matrix.service }}/Dockerfile.production
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NODE_VERSION=${{ env.NODE_VERSION }}
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}
            VERSION=${{ github.ref_name }}
            ENVIRONMENT=production

      - name: Sign container image
        uses: sigstore/cosign-installer@v3
      
      - name: Sign the published Docker image
        run: |
          cosign sign --yes ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ matrix.service }}@${{ steps.build.outputs.digest }}

      - name: Generate and sign SBOM
        uses: anchore/sbom-action@v0
        with:
          image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ matrix.service }}@${{ steps.build.outputs.digest }}
          format: spdx-json
          output-file: ${{ matrix.service }}-production-sbom.spdx.json

      - name: Upload production SBOM
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.service }}-production-sbom
          path: ${{ matrix.service }}-production-sbom.spdx.json

  # ç”Ÿäº§ç¯å¢ƒå®‰å…¨æ‰«æ
  production-security-scan:
    name: Production Security Scan
    runs-on: ubuntu-latest
    needs: build-production-images
    strategy:
      matrix:
        service:
          - phone-gateway
          - configuration-service
          - monitoring
          - smart-whitelist-node

    steps:
      - name: Run comprehensive security scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ matrix.service }}:production-latest
          format: 'sarif'
          output: 'trivy-production-${{ matrix.service }}.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
          exit-code: '1'  # Fail on critical/high vulnerabilities

      - name: Upload security scan results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-production-${{ matrix.service }}.sarif'

      - name: Advanced security scanning
        uses: snyk/actions/docker@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ matrix.service }}:production-latest
          args: --severity-threshold=medium --fail-on=all

  # è“ç»¿éƒ¨ç½²
  blue-green-deployment:
    name: Blue-Green Deployment
    runs-on: ubuntu-latest
    needs: [build-production-images, production-security-scan]
    if: inputs.deployment_strategy == 'blue-green'
    environment:
      name: production
      url: https://api.ai-answer-ninja.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup deployment tools
        run: |
          # Setup kubectl, helm, and AWS CLI
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl && sudo mv kubectl /usr/local/bin/
          
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig --region us-east-1 --name ai-answer-ninja-production

      - name: Deploy to green environment
        run: |
          # éƒ¨ç½²åˆ°ç»¿è‰²ç¯å¢ƒ
          helm upgrade --install ai-answer-ninja-green helm/ai-answer-ninja \
            --namespace production \
            --values helm/ai-answer-ninja/values-production.yaml \
            --set deployment.color=green \
            --set image.tag=production-latest \
            --set ingress.hosts[0]=green.ai-answer-ninja.com \
            --wait --timeout=15m

      - name: Run comprehensive tests on green
        run: |
          sleep 120  # Allow full startup
          
          # è¿è¡Œå®Œæ•´çš„ç”Ÿäº§ç¯å¢ƒæµ‹è¯•å¥—ä»¶
          npm run test:production:comprehensive -- --target=https://green.ai-answer-ninja.com
        env:
          PRODUCTION_API_KEY: ${{ secrets.PRODUCTION_API_KEY }}

      - name: Switch traffic to green
        run: |
          # åˆ‡æ¢æµé‡åˆ°ç»¿è‰²ç¯å¢ƒ
          kubectl patch ingress ai-answer-ninja-ingress -n production \
            -p '{"spec":{"rules":[{"host":"api.ai-answer-ninja.com","http":{"paths":[{"path":"/","pathType":"Prefix","backend":{"service":{"name":"ai-answer-ninja-green","port":{"number":80}}}}]}}]}}'

      - name: Verify traffic switch
        run: |
          sleep 60  # Allow DNS propagation
          
          # éªŒè¯æµé‡åˆ‡æ¢æˆåŠŸ
          for i in {1..10}; do
            if curl -f https://api.ai-answer-ninja.com/health; then
              echo "Traffic successfully switched to green environment"
              break
            fi
            echo "Attempt $i failed, retrying..."
            sleep 30
          done

      - name: Cleanup old blue environment
        run: |
          # åˆ é™¤æ—§çš„è“è‰²ç¯å¢ƒï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          helm uninstall ai-answer-ninja-blue -n production || echo "No blue environment to cleanup"

  # é‡‘ä¸é›€éƒ¨ç½²
  canary-deployment:
    name: Canary Deployment
    runs-on: ubuntu-latest
    needs: [build-production-images, production-security-scan]
    if: inputs.deployment_strategy == 'canary'
    environment:
      name: production
      url: https://api.ai-answer-ninja.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup deployment tools
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl && sudo mv kubectl /usr/local/bin/
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig --region us-east-1 --name ai-answer-ninja-production

      - name: Deploy canary (10% traffic)
        run: |
          # éƒ¨ç½²é‡‘ä¸é›€ç‰ˆæœ¬ï¼Œåˆ†é…10%æµé‡
          helm upgrade --install ai-answer-ninja-canary helm/ai-answer-ninja \
            --namespace production \
            --values helm/ai-answer-ninja/values-production.yaml \
            --set deployment.canary.enabled=true \
            --set deployment.canary.weight=10 \
            --set image.tag=production-latest \
            --wait --timeout=10m

      - name: Monitor canary metrics (5 min)
        run: |
          echo "Monitoring canary deployment for 5 minutes..."
          
          # ç›‘æ§å…³é”®æŒ‡æ ‡
          for i in {1..10}; do
            # é”™è¯¯ç‡æ£€æŸ¥
            ERROR_RATE=$(kubectl exec -n production deployment/ai-answer-ninja-canary -- curl -s http://localhost:9090/metrics | grep -o 'error_rate [0-9.]*' | cut -d' ' -f2)
            
            # å»¶è¿Ÿæ£€æŸ¥
            LATENCY_P95=$(kubectl exec -n production deployment/ai-answer-ninja-canary -- curl -s http://localhost:9090/metrics | grep -o 'latency_p95 [0-9.]*' | cut -d' ' -f2)
            
            echo "Iteration $i: Error Rate: ${ERROR_RATE:-N/A}, P95 Latency: ${LATENCY_P95:-N/A}ms"
            
            # å¦‚æœé”™è¯¯ç‡è¿‡é«˜æˆ–å»¶è¿Ÿè¿‡é«˜ï¼Œåˆ™å›æ»š
            if (( $(echo "$ERROR_RATE > 0.05" | bc -l) )) || (( $(echo "$LATENCY_P95 > 2000" | bc -l) )); then
              echo "Metrics exceeded thresholds, rolling back canary"
              exit 1
            fi
            
            sleep 30
          done

      - name: Increase canary traffic to 50%
        run: |
          helm upgrade ai-answer-ninja-canary helm/ai-answer-ninja \
            --namespace production \
            --values helm/ai-answer-ninja/values-production.yaml \
            --set deployment.canary.weight=50 \
            --wait --timeout=5m

      - name: Monitor high traffic canary (10 min)
        run: |
          echo "Monitoring 50% traffic for 10 minutes..."
          
          for i in {1..20}; do
            ERROR_RATE=$(kubectl exec -n production deployment/ai-answer-ninja-canary -- curl -s http://localhost:9090/metrics | grep -o 'error_rate [0-9.]*' | cut -d' ' -f2)
            
            if (( $(echo "$ERROR_RATE > 0.05" | bc -l) )); then
              echo "High error rate detected, rolling back"
              exit 1
            fi
            
            sleep 30
          done

      - name: Complete canary deployment (100% traffic)
        run: |
          # å°†æ‰€æœ‰æµé‡åˆ‡æ¢åˆ°æ–°ç‰ˆæœ¬
          helm upgrade ai-answer-ninja-canary helm/ai-answer-ninja \
            --namespace production \
            --values helm/ai-answer-ninja/values-production.yaml \
            --set deployment.canary.weight=100 \
            --wait --timeout=5m

      - name: Cleanup old version
        run: |
          # æ¸…ç†æ—§ç‰ˆæœ¬
          kubectl delete deployment ai-answer-ninja-stable -n production || echo "No stable deployment to cleanup"

  # æ»šåŠ¨éƒ¨ç½²
  rolling-deployment:
    name: Rolling Deployment
    runs-on: ubuntu-latest
    needs: [build-production-images, production-security-scan]
    if: inputs.deployment_strategy == 'rolling' || inputs.deployment_strategy == ''
    environment:
      name: production
      url: https://api.ai-answer-ninja.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup deployment tools
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl && sudo mv kubectl /usr/local/bin/
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig --region us-east-1 --name ai-answer-ninja-production

      - name: Rolling deployment
        run: |
          # æ‰§è¡Œæ»šåŠ¨æ›´æ–°
          helm upgrade --install ai-answer-ninja helm/ai-answer-ninja \
            --namespace production \
            --values helm/ai-answer-ninja/values-production.yaml \
            --set image.tag=production-latest \
            --set deployment.strategy.type=RollingUpdate \
            --set deployment.strategy.rollingUpdate.maxUnavailable=25% \
            --set deployment.strategy.rollingUpdate.maxSurge=25% \
            --wait --timeout=15m

      - name: Verify rolling deployment
        run: |
          # æ£€æŸ¥æ‰€æœ‰Podæ˜¯å¦å¥åº·
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=ai-answer-ninja -n production --timeout=300s
          
          # éªŒè¯æœåŠ¡å¯ç”¨æ€§
          kubectl get deployments -n production
          kubectl get services -n production

  # éƒ¨ç½²åéªŒè¯
  post-deployment-verification:
    name: Post-deployment Verification
    runs-on: ubuntu-latest
    needs: [blue-green-deployment, canary-deployment, rolling-deployment]
    if: always() && (needs.blue-green-deployment.result == 'success' || needs.canary-deployment.result == 'success' || needs.rolling-deployment.result == 'success')
    
    steps:
      - name: Comprehensive health checks
        run: |
          # å…¨é¢çš„å¥åº·æ£€æŸ¥
          for service in phone-gateway configuration-service monitoring smart-whitelist-node; do
            echo "Checking $service health..."
            if ! curl -f "https://api.ai-answer-ninja.com/health/$service"; then
              echo "$service health check failed"
              exit 1
            fi
          done

      - name: End-to-end production tests
        run: |
          # ç«¯åˆ°ç«¯ç”Ÿäº§ç¯å¢ƒæµ‹è¯•
          npm run test:e2e:production
        env:
          PRODUCTION_BASE_URL: https://api.ai-answer-ninja.com
          PRODUCTION_API_KEY: ${{ secrets.PRODUCTION_API_KEY }}

      - name: Performance validation
        run: |
          # æ€§èƒ½åŸºå‡†éªŒè¯
          npm run test:performance:production:validate
        env:
          PRODUCTION_BASE_URL: https://api.ai-answer-ninja.com

      - name: Update monitoring dashboards
        run: |
          # æ›´æ–°Grafanaä»ªè¡¨æ¿ä»¥åæ˜ æ–°éƒ¨ç½²
          curl -X POST "https://grafana.ai-answer-ninja.com/api/annotations" \
            -H "Authorization: Bearer ${{ secrets.GRAFANA_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{
              "text": "Production deployment completed - ${{ github.ref_name }}",
              "tags": ["deployment", "production"],
              "time": '$(date +%s000)'
            }'

  # ç´§æ€¥å›æ»š
  emergency-rollback:
    name: Emergency Rollback
    runs-on: ubuntu-latest
    needs: [post-deployment-verification]
    if: failure()
    environment:
      name: production
    
    steps:
      - name: Setup deployment tools
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl && sudo mv kubectl /usr/local/bin/
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig --region us-east-1 --name ai-answer-ninja-production

      - name: Execute emergency rollback
        run: |
          echo "EMERGENCY: Rolling back production deployment"
          
          # å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬
          helm rollback ai-answer-ninja -n production
          
          # ç­‰å¾…å›æ»šå®Œæˆ
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=ai-answer-ninja -n production --timeout=300s
          
          # éªŒè¯å›æ»šæˆåŠŸ
          curl -f https://api.ai-answer-ninja.com/health

      - name: Emergency notification
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          channel: '#emergency-alerts'
          text: |
            ğŸš¨ EMERGENCY ROLLBACK EXECUTED ğŸš¨
            
            **Production deployment failed and was automatically rolled back**
            **Commit:** ${{ github.sha }}
            **Time:** $(date)
            **Action Required:** Immediate investigation
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # éƒ¨ç½²é€šçŸ¥
  deployment-notifications:
    name: Deployment Notifications
    runs-on: ubuntu-latest
    needs: [blue-green-deployment, canary-deployment, rolling-deployment, post-deployment-verification]
    if: always()
    
    steps:
      - name: Production deployment success notification
        if: success()
        uses: 8398a7/action-slack@v3
        with:
          status: success
          channel: '#production-deployments'
          text: |
            ğŸ‰ Production deployment successful! ğŸ‰
            
            **Version:** ${{ github.ref_name }}
            **Commit:** ${{ github.sha }}
            **Strategy:** ${{ inputs.deployment_strategy || 'rolling' }}
            **Services:** ${{ inputs.services || 'all' }}
            **Production URL:** https://api.ai-answer-ninja.com
            **Deployed at:** $(date)
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Production deployment failure notification
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          channel: '#production-deployments'
          text: |
            âŒ Production deployment failed
            
            **Version:** ${{ github.ref_name }}
            **Commit:** ${{ github.sha }}
            **Strategy:** ${{ inputs.deployment_strategy || 'rolling' }}
            **Logs:** https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
            **Time:** $(date)
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Update release notes
        if: success() && startsWith(github.ref, 'refs/tags/')
        uses: actions/github-script@v7
        with:
          script: |
            const tag = context.ref.replace('refs/tags/', '');
            
            await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: tag,
              name: `Release ${tag}`,
              body: `
            ## ğŸš€ Production Deployment Successful
            
            **Deployment Details:**
            - **Version:** ${tag}
            - **Commit:** ${context.sha}
            - **Strategy:** ${{ inputs.deployment_strategy || 'rolling' }}
            - **Deployed:** ${new Date().toISOString()}
            
            **Services Updated:**
            ${{ inputs.services || 'all' }}
            
            **Environment:**
            - Production URL: https://api.ai-answer-ninja.com
            - Monitoring: https://grafana.ai-answer-ninja.com
            
            ## âœ… Post-deployment Verification
            - Health checks: âœ… Passed
            - E2E tests: âœ… Passed  
            - Performance validation: âœ… Passed
            `,
              prerelease: false
            });

      - name: Teams notification
        if: always()
        uses: aliencube/microsoft-teams-actions@v0.8.0
        with:
          webhook_uri: ${{ secrets.MS_TEAMS_WEBHOOK_URL }}
          title: ${{ success() && 'Production Deployment Success' || 'Production Deployment Failed' }}
          text: |
            **Version:** ${{ github.ref_name }}
            **Status:** ${{ success() && 'SUCCESS' || 'FAILED' }}
            **URL:** https://api.ai-answer-ninja.com
          theme_color: ${{ success() && '00ff00' || 'ff0000' }}