# Conversation Engine TypeScript Service

AIé©±åŠ¨çš„å¯¹è¯å¼•æ“æœåŠ¡ï¼Œä¸“ä¸ºå¤„ç†éªšæ‰°ç”µè¯è€Œè®¾è®¡ã€‚æä¾›æ™ºèƒ½æ„å›¾è¯†åˆ«ã€æƒ…æ„Ÿåˆ†æå’Œä¸ªæ€§åŒ–å“åº”ç”ŸæˆåŠŸèƒ½ã€‚

## åŠŸèƒ½ç‰¹æ€§

### ğŸ§  æ™ºèƒ½æ„å›¾è¯†åˆ«
- **å¤šå±‚æ¬¡åˆ†ç±»ç®—æ³•**ï¼šèåˆå…³é”®è¯ã€è¯­ä¹‰å’Œä¸Šä¸‹æ–‡åˆ†æ
- **æ”¯æŒæ„å›¾ç±»å‹**ï¼šé”€å”®æ¨å¹¿ã€è´·æ¬¾æ¨é”€ã€æŠ•èµ„ç†è´¢ã€ä¿é™©é”€å”®ã€è°ƒæŸ¥è®¿é—®ã€è¯ˆéª—è¯†åˆ«
- **é«˜å‡†ç¡®ç‡**ï¼šç½®ä¿¡åº¦è¯„åˆ†å’Œå¤‡é€‰æ„å›¾æ¨è

### ğŸ’­ æƒ…æ„Ÿåˆ†æå¼•æ“
- **å®æ—¶æƒ…æ„Ÿæ£€æµ‹**ï¼šåˆ†ææ¥ç”µè€…çš„æƒ…æ„ŸçŠ¶æ€å’Œå¼ºåº¦
- **æƒ…æ„Ÿå‡çº§æ£€æµ‹**ï¼šè¯†åˆ«å¯¹è¯ä¸­çš„æƒ…æ„Ÿå˜åŒ–è¶‹åŠ¿
- **å¤šç»´åº¦åˆ†æ**ï¼šæƒ…æ„Ÿæ•ˆä»·ã€å”¤é†’åº¦å’Œç½®ä¿¡åº¦è¯„ä¼°

### ğŸ­ ä¸ªæ€§åŒ–å“åº”ç”Ÿæˆ
- **ç”¨æˆ·ç”»åƒé©±åŠ¨**ï¼šåŸºäºä¸ªæ€§ç±»å‹ç”Ÿæˆç¬¦åˆç”¨æˆ·ç‰¹å¾çš„å›å¤
- **Azure OpenAIé›†æˆ**ï¼šåˆ©ç”¨GPT-4ç”Ÿæˆè‡ªç„¶æµç•…çš„å¯¹è¯
- **å“åº”æ¨¡æ¿ç³»ç»Ÿ**ï¼šé¢„å®šä¹‰æ¨¡æ¿ä¸AIç”Ÿæˆç›¸ç»“åˆ
- **å¤šç§ä¸ªæ€§æ”¯æŒ**ï¼šç¤¼è²Œå‹ã€ç›´æ¥å‹ã€å¹½é»˜å‹ã€ä¸“ä¸šå‹ã€å‹å¥½å‹

### ğŸ“ å¯¹è¯ä¸Šä¸‹æ–‡ç®¡ç†
- **çŠ¶æ€è·Ÿè¸ª**ï¼šå®Œæ•´çš„å¯¹è¯çŠ¶æ€æœºç®¡ç†
- **å†å²è®°å½•**ï¼šå¯¹è¯è½®æ¬¡å’Œå†…å®¹çš„æŒä¹…åŒ–å­˜å‚¨
- **æ™ºèƒ½ç»ˆæ­¢**ï¼šåŸºäºå¤šç§ç­–ç•¥çš„å¯¹è¯ç»“æŸåˆ¤æ–­

### âš¡ é«˜æ€§èƒ½æ¶æ„
- **å¤šçº§ç¼“å­˜**ï¼šå†…å­˜ç¼“å­˜ + Redisç¼“å­˜ä¼˜åŒ–å“åº”é€Ÿåº¦
- **å¹¶è¡Œå¤„ç†**ï¼šæ„å›¾è¯†åˆ«å’Œæƒ…æ„Ÿåˆ†æå¹¶è¡Œæ‰§è¡Œ
- **é¢„æµ‹ç¼“å­˜**ï¼šå¸¸è§åœºæ™¯çš„é¢„è®¡ç®—å“åº”

## æŠ€æœ¯æ ˆ

- **è¿è¡Œæ—¶**ï¼šNode.js 18+ / TypeScript 5.2+
- **Webæ¡†æ¶**ï¼šExpress.js
- **AIæœåŠ¡**ï¼šAzure OpenAI GPT-4
- **æ•°æ®åº“**ï¼šPostgreSQL (å¯¹è¯æ•°æ®) + Redis (ç¼“å­˜)
- **è‡ªç„¶è¯­è¨€å¤„ç†**ï¼šNatural.js, Sentiment.js
- **å®¹å™¨åŒ–**ï¼šDocker + Docker Compose

## å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚
- Node.js 18+
- Docker & Docker Compose
- Azure OpenAI æœåŠ¡è´¦æˆ·

### 1. ç¯å¢ƒé…ç½®
```bash
# å¤åˆ¶ç¯å¢ƒå˜é‡æ¨¡æ¿
cp .env.example .env

# ç¼–è¾‘ç¯å¢ƒå˜é‡
vim .env
```

å¿…éœ€çš„ç¯å¢ƒå˜é‡ï¼š
```env
# Azure OpenAI é…ç½®
AZURE_OPENAI_ENDPOINT=https://your-openai-resource.openai.azure.com/
AZURE_OPENAI_API_KEY=your-api-key
AZURE_OPENAI_DEPLOYMENT_NAME=gpt-4

# æ•°æ®åº“é…ç½®
DATABASE_URL=postgresql://postgres:password@localhost:5432/ai_ninja
REDIS_URL=redis://localhost:6379
```

### 2. å¼€å‘ç¯å¢ƒå¯åŠ¨
```bash
# å®‰è£…ä¾èµ–
npm install

# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
npm run dev

# æˆ–ä½¿ç”¨ Docker Compose
docker-compose up -d
```

### 3. ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
```bash
# æ„å»ºç”Ÿäº§é•œåƒ
docker-compose -f docker-compose.yml up -d

# æˆ–ä½¿ç”¨å•ç‹¬æ„å»º
npm run build
npm start
```

## API æ¥å£

### å¯¹è¯å¤„ç†
```http
POST /api/v1/conversation/process
Content-Type: application/json

{
  "callId": "call_123456",
  "userInput": "æˆ‘æƒ³äº†è§£ä¸€ä¸‹ä½ ä»¬çš„ç†è´¢äº§å“",
  "metadata": {
    "userId": "user_789",
    "callerPhone": "+86138****1234",
    "sessionId": "session_abc"
  }
}
```

å“åº”ï¼š
```json
{
  "success": true,
  "data": {
    "callId": "call_123456",
    "response": {
      "text": "è°¢è°¢æ‚¨çš„ä»‹ç»ï¼Œä½†æˆ‘ç°åœ¨ä¸è€ƒè™‘ç†è´¢äº§å“ã€‚",
      "confidence": 0.89,
      "shouldTerminate": false,
      "nextStage": "polite_decline",
      "emotion": "polite",
      "metadata": {
        "strategy": "gentle_decline",
        "generationLatency": 245,
        "cacheHit": false
      }
    }
  }
}
```

### å¯¹è¯ç»Ÿè®¡
```http
GET /api/v1/conversation/{callId}/stats
```

### æ‰¹é‡å¤„ç†
```http
POST /api/v1/conversation/batch
Content-Type: application/json

{
  "conversations": [
    {
      "callId": "call_001",
      "userInput": "äº†è§£è´·æ¬¾äº§å“",
      "metadata": {}
    }
  ]
}
```

### å¥åº·æ£€æŸ¥
```http
GET /health                 # åŸºç¡€å¥åº·æ£€æŸ¥
GET /health/detailed        # è¯¦ç»†å¥åº·æ£€æŸ¥
GET /health/liveness        # Kubernetes å­˜æ´»æ£€æŸ¥
GET /health/readiness       # Kubernetes å°±ç»ªæ£€æŸ¥
```

## é…ç½®è¯´æ˜

### æ€§èƒ½é…ç½®
```env
MAX_CONVERSATION_TURNS=10          # æœ€å¤§å¯¹è¯è½®æ¬¡
MAX_RESPONSE_LENGTH=200            # æœ€å¤§å“åº”é•¿åº¦
INTENT_CONFIDENCE_THRESHOLD=0.7    # æ„å›¾è¯†åˆ«ç½®ä¿¡åº¦é˜ˆå€¼
CACHE_TTL=3600                     # ç¼“å­˜ç”Ÿå­˜æ—¶é—´(ç§’)
RESPONSE_CACHE_TTL=1800           # å“åº”ç¼“å­˜æ—¶é—´(ç§’)
```

### ä¸ªæ€§åŒ–é…ç½®
æ”¯æŒçš„ä¸ªæ€§ç±»å‹ï¼š
- `polite` - ç¤¼è²Œå‹ï¼šæ¸©å’Œå‹å–„ï¼Œå³ä½¿æ‹’ç»ä¹Ÿå¾ˆå®¢æ°”
- `direct` - ç›´æ¥å‹ï¼šç›´æˆªäº†å½“ï¼Œä¸å–œæ¬¢æ‹å¼¯æŠ¹è§’
- `humorous` - å¹½é»˜å‹ï¼šå–„ç”¨å¹½é»˜åŒ–è§£å°´å°¬
- `professional` - ä¸“ä¸šå‹ï¼šæ­£å¼è§„èŒƒçš„äº¤æµæ–¹å¼
- `friendly` - å‹å¥½å‹ï¼šçƒ­æƒ…å‹å¥½ä½†çŸ¥é“è®¾ç½®ç•Œé™

### æ„å›¾åˆ†ç±»
æ”¯æŒçš„éªšæ‰°ç”µè¯ç±»å‹ï¼š
- `sales_call` - é”€å”®æ¨å¹¿
- `loan_offer` - è´·æ¬¾æ¨é”€
- `investment_pitch` - æŠ•èµ„ç†è´¢
- `insurance_sales` - ä¿é™©é”€å”®
- `survey_request` - è°ƒæŸ¥è®¿é—®
- `scam_attempt` - è¯ˆéª—å«Œç–‘
- `legitimate_call` - æ­£å½“æ¥ç”µ

## ç›‘æ§å’Œæ—¥å¿—

### å¥åº·ç›‘æ§
- æœåŠ¡è‡ªèº«çŠ¶æ€
- Azure OpenAI è¿æ¥çŠ¶æ€
- Redis ç¼“å­˜çŠ¶æ€
- PostgreSQL æ•°æ®åº“çŠ¶æ€
- å†…å­˜å’Œç£ç›˜ä½¿ç”¨æƒ…å†µ

### æ€§èƒ½æŒ‡æ ‡
- å“åº”ç”Ÿæˆå»¶è¿Ÿ
- æ„å›¾è¯†åˆ«å‡†ç¡®ç‡
- ç¼“å­˜å‘½ä¸­ç‡
- å¯¹è¯æˆåŠŸç»ˆæ­¢ç‡

### æ—¥å¿—çº§åˆ«
```env
LOG_LEVEL=info              # debug, info, warn, error
LOG_FORMAT=json             # json, simple
ENABLE_REQUEST_LOGGING=true # å¯ç”¨è¯·æ±‚æ—¥å¿—
```

## å¼€å‘æŒ‡å—

### é¡¹ç›®ç»“æ„
```
src/
â”œâ”€â”€ analysis/           # æƒ…æ„Ÿåˆ†ææ¨¡å—
â”œâ”€â”€ config/            # é…ç½®ç®¡ç†
â”œâ”€â”€ context/           # å¯¹è¯ä¸Šä¸‹æ–‡ç®¡ç†
â”œâ”€â”€ controllers/       # HTTP æ§åˆ¶å™¨
â”œâ”€â”€ engine/            # å¯¹è¯å¼•æ“æ ¸å¿ƒ
â”œâ”€â”€ intent/            # æ„å›¾è¯†åˆ«æ¨¡å—
â”œâ”€â”€ response/          # å“åº”ç”Ÿæˆæ¨¡å—
â”œâ”€â”€ routes/            # è·¯ç”±é…ç½®
â”œâ”€â”€ types/             # TypeScript ç±»å‹å®šä¹‰
â”œâ”€â”€ utils/             # å·¥å…·å‡½æ•°
â””â”€â”€ server.ts          # ä¸»æœåŠ¡å™¨æ–‡ä»¶
```

### æ‰©å±•æ–°çš„æ„å›¾ç±»å‹
1. åœ¨ `types/index.ts` ä¸­æ·»åŠ æ–°çš„ `IntentCategory`
2. åœ¨ `IntentClassifier.ts` ä¸­æ·»åŠ å…³é”®è¯æ¨¡å¼
3. åœ¨ `ResponseGenerator.ts` ä¸­æ·»åŠ ç›¸åº”çš„å“åº”æ¨¡æ¿

### æ·»åŠ æ–°çš„ä¸ªæ€§ç±»å‹
1. åœ¨ `types/index.ts` ä¸­æ‰©å±• `PersonalityType`
2. åœ¨ `ResponseGenerator.ts` ä¸­æ·»åŠ ä¸ªæ€§åŒ–ç­–ç•¥
3. æ›´æ–°å“åº”æ¨¡æ¿æ”¯æŒæ–°ä¸ªæ€§

### æµ‹è¯•
```bash
# è¿è¡Œå•å…ƒæµ‹è¯•
npm test

# è¿è¡Œæµ‹è¯•è¦†ç›–ç‡
npm run test:coverage

# è¿è¡Œ ESLint
npm run lint
```

## æ€§èƒ½ä¼˜åŒ–

### å“åº”æ—¶é—´ä¼˜åŒ–
- **å¹¶è¡Œå¤„ç†**ï¼šæ„å›¾è¯†åˆ«å’Œæƒ…æ„Ÿåˆ†æå¹¶è¡Œæ‰§è¡Œ
- **æ™ºèƒ½ç¼“å­˜**ï¼šå¸¸è§åœºæ™¯é¢„è®¡ç®—ç¼“å­˜
- **æ¨¡æ¿ä¼˜å…ˆ**ï¼šç®€å•åœºæ™¯ä½¿ç”¨æ¨¡æ¿é¿å…AIè°ƒç”¨
- **è¿æ¥æ± **ï¼šæ•°æ®åº“å’ŒRedisè¿æ¥å¤ç”¨

### å†…å­˜ä¼˜åŒ–
- **å†…å­˜ç¼“å­˜é™åˆ¶**ï¼šé˜²æ­¢å†…å­˜æ³„æ¼
- **å®šæœŸæ¸…ç†**ï¼šè¿‡æœŸæ•°æ®è‡ªåŠ¨æ¸…ç†
- **åˆ†é¡µæŸ¥è¯¢**ï¼šå¤§æ•°æ®é‡åˆ†é¡µå¤„ç†

### å¹¶å‘å¤„ç†
- **é€Ÿç‡é™åˆ¶**ï¼šé˜²æ­¢APIæ»¥ç”¨
- **ç†”æ–­æœºåˆ¶**ï¼šå¤–éƒ¨æœåŠ¡æ•…éšœæ—¶çš„é™çº§å¤„ç†
- **èµ„æºé™åˆ¶**ï¼šDockerå®¹å™¨èµ„æºé™åˆ¶

## éƒ¨ç½²æŒ‡å—

### Docker éƒ¨ç½²
```bash
# å•æœåŠ¡éƒ¨ç½²
docker build -t conversation-engine .
docker run -p 3003:3003 conversation-engine

# å®Œæ•´ç¯å¢ƒéƒ¨ç½²
docker-compose up -d
```

### Kubernetes éƒ¨ç½²
```yaml
# k8s-deployment.yaml ç¤ºä¾‹
apiVersion: apps/v1
kind: Deployment
metadata:
  name: conversation-engine
spec:
  replicas: 3
  selector:
    matchLabels:
      app: conversation-engine
  template:
    metadata:
      labels:
        app: conversation-engine
    spec:
      containers:
      - name: conversation-engine
        image: ai-ninja/conversation-engine:latest
        ports:
        - containerPort: 3003
        env:
        - name: NODE_ENV
          value: "production"
        resources:
          limits:
            memory: "1Gi"
            cpu: "500m"
          requests:
            memory: "512Mi"
            cpu: "250m"
        livenessProbe:
          httpGet:
            path: /health/liveness
            port: 3003
          initialDelaySeconds: 60
          periodSeconds: 30
        readinessProbe:
          httpGet:
            path: /health/readiness
            port: 3003
          initialDelaySeconds: 30
          periodSeconds: 10
```

### ç¯å¢ƒå˜é‡ç®¡ç†
ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨ï¼š
- Kubernetes Secrets
- HashiCorp Vault
- Azure Key Vault
- ç¯å¢ƒå˜é‡åŠ å¯†

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **Azure OpenAI è¿æ¥å¤±è´¥**
   - æ£€æŸ¥ API å¯†é’¥å’Œç«¯ç‚¹é…ç½®
   - éªŒè¯ç½‘ç»œè¿æ¥å’Œé˜²ç«å¢™è®¾ç½®
   - ç¡®è®¤éƒ¨ç½²æ¨¡å‹åç§°æ­£ç¡®

2. **å“åº”å»¶è¿Ÿè¿‡é«˜**
   - æ£€æŸ¥ Redis ç¼“å­˜çŠ¶æ€
   - ç›‘æ§ Azure OpenAI å“åº”æ—¶é—´
   - è°ƒæ•´å¹¶å‘å¤„ç†å‚æ•°

3. **å†…å­˜ä½¿ç”¨è¿‡é«˜**
   - æ£€æŸ¥ç¼“å­˜å¤§å°è®¾ç½®
   - ç›‘æ§å¯¹è¯ä¸Šä¸‹æ–‡æ•°é‡
   - è°ƒæ•´åƒåœ¾å›æ”¶å‚æ•°

### æ—¥å¿—åˆ†æ
```bash
# æŸ¥çœ‹æœåŠ¡æ—¥å¿—
docker-compose logs -f conversation-engine

# è¿‡æ»¤é”™è¯¯æ—¥å¿—
docker-compose logs conversation-engine | grep ERROR

# æ€§èƒ½æ—¥å¿—åˆ†æ
docker-compose logs conversation-engine | grep "performance"
```

## è´¡çŒ®æŒ‡å—

1. Fork é¡¹ç›®
2. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯ (`git checkout -b feature/amazing-feature`)
3. æäº¤æ›´æ”¹ (`git commit -m 'Add amazing feature'`)
4. æ¨é€åˆ°åˆ†æ”¯ (`git push origin feature/amazing-feature`)
5. åˆ›å»º Pull Request

## è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ - æŸ¥çœ‹ [LICENSE](LICENSE) æ–‡ä»¶äº†è§£è¯¦æƒ…ã€‚

## è”ç³»æ–¹å¼

- é¡¹ç›®ä¸»é¡µï¼šhttps://github.com/ai-answer-ninja/conversation-engine
- é—®é¢˜åé¦ˆï¼šhttps://github.com/ai-answer-ninja/conversation-engine/issues
- é‚®ç®±ï¼šdev@ai-answer-ninja.com

---

**æ³¨æ„**ï¼šæœ¬æœåŠ¡éœ€è¦ Azure OpenAI æœåŠ¡æ”¯æŒï¼Œè¯·ç¡®ä¿å·²æ­£ç¡®é…ç½®ç›¸å…³æœåŠ¡å’ŒAPIå¯†é’¥ã€‚